<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSFS 2024 Keybinds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .keyboard-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 900px;
            margin: 2rem auto;
            background: #232946;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        .keyboard-row {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        .key {
            background-color: #1e1e2d;
            border: 1px solid #3e405d;
            border-radius: 0.5rem;
            color: #c9d1d9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem;
            min-width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.1s ease-in-out;
            position: relative;
        }
        .key-large {
            flex-grow: 1;
        }
        .key-space {
            min-width: 300px;
        }
        .key-pressed {
            transform: scale(0.95);
            background-color: #fca5a5;
            color: #1a1a2e;
            box-shadow: 0 0 10px rgba(252, 165, 165, 0.7);
        }
        .key-selected {
            background-color: #60a5fa;
            color: #1a1a2e;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.7);
            transform: scale(0.95);
        }
        #keybind-display {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #2e304f;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
            min-height: 4rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease-in-out;
        }
        #keybind-display ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            max-width: 100%;
            width: 100%;
        }
        #keybind-display li {
            background-color: #3e405d;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #keybind-display.display-inactive {
            opacity: 0.4;
        }
        .create-button {
            background-color: #4a5568;
            color: #e2e8f0;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            transition: background-color 0.2s;
        }
        .create-button:hover {
            background-color: #2d3748;
        }
        .remove-button {
            color: #ef4444;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            padding: 0 0.25rem;
            transition: color 0.2s;
        }
        .remove-button:hover {
            color: #dc2626;
        }
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #2d3748;
            margin: auto;
            padding: 20px;
            border: 1px solid #4a5568;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            color: #e2e8f0;
            text-align: left;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #e2e8f0;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: #3e405d;
            border: 1px solid #4a5568;
            border-radius: 0.25rem;
            color: #e2e8f0;
            transition: all 0.2s;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal-save-button {
            background-color: #84cc16;
            color: #1a1a2e;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-save-button:hover {
            background-color: #65a30d;
        }
        .modal-record-button {
            background-color: #f59e0b;
            color: #1a1a2e;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-record-button:hover {
            background-color: #d97706;
        }
        .modal-text-input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: #3e405d;
            border: 1px solid #4a5568;
            border-radius: 0.25rem;
            color: #e2e8f0;
        }
        .disabled-button {
            background-color: #4a5568;
            color: #a0aec0;
            cursor: not-allowed;
        }
        .disabled-button:hover {
            background-color: #4a5568;
        }
        .key-combo-conflict {
            color: #f87171;
            border-color: #ef4444;
        }
        .conflict-warning {
            color: #fca5a5;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        #search-dropdown {
            position: absolute;
            width: 100%;
            max-height: 240px;
            overflow-y: auto;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            z-index: 50;
        }
        #search-dropdown li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: #e2e8f0;
        }
        #search-dropdown li:hover {
            background-color: #4a5568;
        }
    </style>
</head>
<body class="bg-[#1a1a2e]">
    <div class="keyboard-container">
        <h1 class="text-3xl font-bold text-center text-white">2024 MSFS Keybinds</h1>
        <p class="text-center text-sm mb-6 text-gray-400">created by TrashCatFPV</p>

        <div class="bg-[#2e304f] p-4 rounded-lg mb-6 border border-[#3e405d]">
            <h2 class="text-xl font-bold text-center text-white mb-3">How to Use This App üìã</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-300">
                <li><strong>View Keybinds:</strong> Click a virtual key or press a physical key to see its functions.</li>
                <li><strong>Search Commands:</strong> Use the search bar to find functions by name. Click it while empty to see all options.</li>
                <li><strong>Create Custom Keybinds:</strong> Click the "Create Your Own Keybind..." button to add your own commands. Your custom keybinds are saved automatically!</li>
                <li><strong>Remove Keybinds:</strong> Click the <span class="text-red-500 font-bold text-lg">&times;</span> next to a command to delete it.</li>
                <li><strong>Reset All:</strong> Click the "Reset to Defaults" button to remove all custom keybinds.</li>
            </ul>
        </div>

        <div id="keyboard-layout">
            <div class="keyboard-row">
                <div class="key" id="reset-button" data-key="ResetDefaults">Reset to Defaults</div>
                <div class="key" data-key="Escape">Esc</div>
                <div class="key" data-key="F1">F1</div>
                <div class="key" data-key="F2">F2</div>
                <div class="key" data-key="F3">F3</div>
                <div class="key" data-key="F4">F4</div>
                <div class="key" data-key="F5">F5</div>
                <div class="key" data-key="F6">F6</div>
                <div class="key" data-key="F7">F7</div>
                <div class="key" data-key="F8">F8</div>
                <div class="key" data-key="F9">F9</div>
                <div class="key" data-key="F10">F10</div>
                <div class="key" data-key="F11">F11</div>
                <div class="key" data-key="F12">F12</div>
                <div class="key">PrtSc</div>
                <div class="key" data-key="Delete">Del</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key="Backquote">`</div>
                <div class="key" data-key="Digit1">1</div>
                <div class="key" data-key="Digit2">2</div>
                <div class="key" data-key="Digit3">3</div>
                <div class="key" data-key="Digit4">4</div>
                <div class="key" data-key="Digit5">5</div>
                <div class="key" data-key="Digit6">6</div>
                <div class="key" data-key="Digit7">7</div>
                <div class="key" data-key="Digit8">8</div>
                <div class="key" data-key="Digit9">9</div>
                <div class="key" data-key="Digit0">0</div>
                <div class="key" data-key="Minus">-</div>
                <div class="key" data-key="Equal">=</div>
                <div class="key key-large" data-key="Backspace">Backspace</div>
            </div>
            <div class="keyboard-row">
                <div class="key key-large" data-key="Tab">Tab</div>
                <div class="key" data-key="KeyQ">Q</div>
                <div class="key" data-key="KeyW">W</div>
                <div class="key" data-key="KeyE">E</div>
                <div class="key" data-key="KeyR">R</div>
                <div class="key" data-key="KeyT">T</div>
                <div class="key" data-key="KeyY">Y</div>
                <div class="key" data-key="KeyU">U</div>
                <div class="key" data-key="KeyI">I</div>
                <div class="key" data-key="KeyO">O</div>
                <div class="key" data-key="KeyP">P</div>
                <div class="key" data-key="BracketLeft">[</div>
                <div class="key" data-key="BracketRight">]</div>
                <div class="key key-large" data-key="Backslash">\</div>
            </div>
            <div class="keyboard-row">
                <div class="key key-large" data-key="CapsLock">Caps</div>
                <div class="key" data-key="KeyA">A</div>
                <div class="key" data-key="KeyS">S</div>
                <div class="key" data-key="KeyD">D</div>
                <div class="key" data-key="KeyF">F</div>
                <div class="key" data-key="KeyG">G</div>
                <div class="key" data-key="KeyH">H</div>
                <div class="key" data-key="KeyJ">J</div>
                <div class="key" data-key="KeyK">K</div>
                <div class="key" data-key="KeyL">L</div>
                <div class="key" data-key="Semicolon">;</div>
                <div class="key" data-key="Quote">'</div>
                <div class="key key-large" data-key="Enter">Enter</div>
            </div>
            <div class="keyboard-row">
                <div class="key key-large" data-key="ShiftLeft">Shift</div>
                <div class="key" data-key="KeyZ">Z</div>
                <div class="key" data-key="KeyX">X</div>
                <div class="key" data-key="KeyC">C</div>
                <div class="key" data-key="KeyV">V</div>
                <div class="key" data-key="KeyB">B</div>
                <div class="key" data-key="KeyN">N</div>
                <div class="key" data-key="KeyM">M</div>
                <div class="key" data-key="Comma">,</div>
                <div class="key" data-key="Period">.</div>
                <div class="key" data-key="Slash">/</div>
                <div class="key key-large" data-key="ShiftRight">Shift</div>
            </div>
            <div class="keyboard-row">
                <div class="key key-large" data-key="ControlLeft">Ctrl</div>
                <div class="key" data-key="MetaLeft">Win</div>
                <div class="key key-large" data-key="AltLeft">Alt</div>
                <div class="key key-space" data-key="Space">Space</div>
                <div class="key key-large" data-key="AltRight">Alt</div>
                <div class="key" data-key="MetaRight">Win</div>
                <div class="key key-large" data-key="ControlRight">Ctrl</div>
                <div class="key" data-key="ArrowUp">‚Üë</div>
                <div class="key" data-key="ArrowLeft">‚Üê</div>
                <div class="key" data-key="ArrowDown">‚Üì</div>
                <div class="key" data-key="ArrowRight">‚Üí</div>
            </div>
        </div>

        <div id="search-container" class="mt-4 relative">
            <input type="text" id="search-input" placeholder="Search for a function..." class="modal-text-input" autocomplete="off">
            <div id="search-dropdown" class="hidden">
                <ul id="search-results-list"></ul>
            </div>
        </div>

        <div id="keybind-display" class="bg-[#2e304f] text-green-300">
            <!-- Content will be dynamically inserted here by JavaScript -->
        </div>

        <div id="createModal" class="modal hidden">
            <div class="modal-content">
                <span class="close-button" id="closeModalBtn">&times;</span>
                <h3 class="text-lg font-bold mb-4">Create Your Own Keybind</h3>
                
                <label for="keyAction" class="block mb-2">Action Description:</label>
                <input type="text" id="keyAction" class="modal-text-input" placeholder="e.g., Toggle cockpit lights">

                <label for="keyCombination" class="block mt-4 mb-2">Key Combination:</label>
                <div id="keyCombinationDisplay" class="modal-input mb-2" data-keybind-combo="">
                    Press the "Record Keybind" button below to start...
                </div>
                <!-- Conflict warning will be inserted here by JS -->
                <div class="flex gap-2 mt-4">
                    <button id="recordKeybindBtn" class="modal-record-button">Record Keybind</button>
                    <button id="clearRecordingBtn" class="create-button disabled-button">Clear</button>
                    <button id="stopRecordingBtn" class="create-button disabled-button">Stop Recording</button>
                </div>
                
                <div class="modal-buttons">
                    <button id="saveKeybindBtn" class="modal-save-button">Save Keybind</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const defaultKeybindsData = [
                // Default keybind data remains the same...
                { id: 'uuid-1', keys: ['Escape'], action: 'Pause' },
                { id: 'uuid-2', keys: ['F1'], action: 'Mixture Cut / Throttle Cut' },
                { id: 'uuid-3', keys: ['F2'], action: 'Decrease Throttle' },
                { id: 'uuid-4', keys: ['F3'], action: 'Increase Throttle' },
                { id: 'uuid-5', keys: ['F4'], action: 'Set Throttle Max' },
                { id: 'uuid-6', keys: ['F5'], action: 'Retract Flaps' },
                { id: 'uuid-7', keys: ['F6'], action: 'Decrease Flaps' },
                { id: 'uuid-8', keys: ['F7'], action: 'Increase Flaps' },
                { id: 'uuid-9', keys: ['F8'], action: 'Extend Flaps' },
                { id: 'uuid-10', keys: ['F9'], action: 'Toggle IFR Cockpit Mode' },
                { id: 'uuid-11', keys: ['F10'], action: 'Toggle VFR Cockpit Mode' },
                { id: 'uuid-12', keys: ['F11'], action: 'Toggle Landing Cockpit Mode' },
                { id: 'uuid-13', keys: ['F12'], action: 'Toggle Fixed Camera' },
                { id: 'uuid-14', keys: ['Delete'], action: 'Clear Search' },
                { id: 'uuid-15', keys: ['Backquote'], action: 'Display/Hide ATC Menu' },
                { id: 'uuid-16', keys: ['Backspace'], action: 'Toggle View Mode' },
                { id: 'uuid-17', keys: ['KeyQ'], action: 'Rudder Left (Yaw Left)' },
                { id: 'uuid-18', keys: ['KeyW'], action: 'Elevator Down (Pitch Down)' },
                { id: 'uuid-19', keys: ['KeyE'], action: 'Rudder Right (Yaw Right)' },
                { id: 'uuid-20', keys: ['KeyR'], action: 'Toggle Slew Mode' },
                { id: 'uuid-21', keys: ['KeyT'], action: 'Set Custom Smartcam Target' },
                { id: 'uuid-22', keys: ['KeyY'], action: 'Toggle Slew Mode' },
                { id: 'uuid-23', keys: ['KeyI'], action: 'External View Look Down' },
                { id: 'uuid-24', keys: ['KeyO'], action: 'Toggle Strobes' },
                { id: 'uuid-25', keys: ['KeyP'], action: 'Toggle Pitot Heat' },
                { id: 'uuid-26', keys: ['KeyA'], action: 'Aileron Left (Roll Left)' },
                { id: 'uuid-27', keys: ['KeyS'], action: 'Elevator Up (Pitch Up)' },
                { id: 'uuid-28', keys: ['KeyD'], action: 'Aileron Right (Roll Right)' },
                { id: 'uuid-29', keys: ['KeyF'], action: 'Reset Cockpit View / Fixed Camera' },
                { id: 'uuid-30', keys: ['KeyG'], action: 'Toggle Landing Gear' },
                { id: 'uuid-31', keys: ['KeyH'], action: 'Toggle Anti-Ice' },
                { id: 'uuid-32', keys: ['KeyJ'], action: 'External View Look Right' },
                { id: 'uuid-33', keys: ['KeyK'], action: 'External View Look Up' },
                { id: 'uuid-34', keys: ['KeyL'], action: 'Toggle Lights' },
                { id: 'uuid-35', keys: ['KeyZ'], action: 'Toggle Autopilot Master' },
                { id: 'uuid-36', keys: ['KeyX'], action: 'Toggle Avionics Master' },
                { id: 'uuid-37', keys: ['KeyC'], action: 'Com Radio' },
                { id: 'uuid-38', keys: ['KeyV'], action: 'Capture Screenshot' },
                { id: 'uuid-39', keys: ['KeyB'], action: 'Set Altimeter' },
                { id: 'uuid-40', keys: ['KeyN'], action: 'Toggle Nav Lights' },
                { id: 'uuid-41', keys: ['KeyM'], action: 'Toggle GPS' },
                { id: 'uuid-42', keys: ['Slash'], action: 'Toggle Spoilers' },
                { id: 'uuid-43', keys: ['Comma'], action: 'Decrease Selection' },
                { id: 'uuid-44', keys: ['Period'], action: 'Apply/Release Brakes' },
                { id: 'uuid-45', keys: ['Space'], action: 'Apply/Release Brakes' },
                { id: 'uuid-46', keys: ['ArrowUp'], action: 'Translate Cockpit View Forward' },
                { id: 'uuid-47', keys: ['ArrowLeft'], action: 'Translate Cockpit View Left' },
                { id: 'uuid-48', keys: ['ArrowDown'], action: 'Translate Cockpit View Backward' },
                { id: 'uuid-49', keys: ['ArrowRight'], action: 'Translate Cockpit View Right' },
                { id: 'uuid-50', keys: ['ShiftLeft', 'KeyA'], action: 'Previous Instrument View' },
                { id: 'uuid-51', keys: ['ShiftLeft', 'KeyR'], action: 'Previous SmartCam Target' },
                { id: 'uuid-52', keys: ['ShiftLeft', 'KeyC'], action: 'Display Checklist' },
                { id: 'uuid-53', keys: ['ShiftLeft', 'KeyH'], action: 'External QuickView Left' },
                { id: 'uuid-54', keys: ['ShiftLeft', 'KeyJ'], action: 'External View Look Right' },
                { id: 'uuid-55', keys: ['ShiftLeft', 'KeyK'], action: 'External View Look Up' },
                { id: 'uuid-56', keys: ['ShiftLeft', 'KeyL'], action: 'Toggle Panel Lights' },
                { id: 'uuid-57', keys: ['ShiftLeft', 'KeyE'], action: 'Increase Cockpit View Height' },
                { id: 'uuid-58', keys: ['ShiftLeft', 'KeyQ'], action: 'Decrease Cockpit View Height' },
                { id: 'uuid-59', keys: ['ControlLeft', 'KeyA'], action: 'Toggle Autopilot Approach Hold' },
                { id: 'uuid-60', keys: ['ControlLeft', 'KeyF'], action: 'Toggle Flight Director' },
                { id: 'uuid-61', keys: ['ControlLeft', 'KeyJ'], action: 'Jetway (attach/detach)' },
                { id: 'uuid-62', keys: ['ControlLeft', 'KeyP'], action: 'Toggle Autopilot Pitch Hold' },
                { id: 'uuid-63', keys: ['ControlLeft', 'KeyE'], action: 'Toggle Auto-Start Engine' },
                { id: 'uuid-64', keys: ['ControlLeft', 'Digit3'], action: 'Toggle Autopilot Master' },
                { id: 'uuid-65', keys: ['ControlLeft', 'AltLeft', 'Digit3'], action: 'Save Custom Camera 3' },
                { id: 'uuid-66', keys: ['ControlLeft', 'AltLeft', 'Digit1'], action: 'Save Custom Camera 1' },
                { id: 'uuid-67', keys: ['ControlLeft', 'AltLeft', 'Digit2'], action: 'Save Custom Camera 2' },
                { id: 'uuid-68', keys: ['ControlLeft', 'PageUp'], action: 'Increase Autopilot Reference Altitude' },
                { id: 'uuid-69', keys: ['ControlLeft', 'PageDown'], action: 'Decrease Autopilot Reference Altitude' },
                { id: 'uuid-70', keys: ['ControlLeft', 'KeyZ'], action: 'Toggle Autopilot Master' },
                { id: 'uuid-71', keys: ['ControlLeft', 'Space'], action: 'Reset Cockpit View' },
                { id: 'uuid-72', keys: ['AltLeft', 'KeyZ'], action: 'Autopilot On' },
                { id: 'uuid-73', keys: ['AltLeft', 'KeyI'], action: 'Toggle Master Ignition Switch' },
                { id: 'uuid-74', keys: ['AltLeft', 'KeyS'], action: 'Toggle Alternate Static' },
                { id: 'uuid-75', keys: ['AltLeft', 'KeyF'], action: 'Toggle Flashlight' },
                { id: 'uuid-76', keys: ['AltLeft', 'KeyB'], action: 'Select Airspeed Bug' },
                { id: 'uuid-77', keys: ['AltLeft', 'Digit3'], action: 'Load Custom Camera 3' },
            ];

            // --- App State & Core Functions ---
            const saveKeybinds = () => localStorage.setItem('msfsKeybinds', JSON.stringify(keybindsData));
            const loadKeybinds = () => JSON.parse(localStorage.getItem('msfsKeybinds')) || [...defaultKeybindsData];
            let keybindsData = loadKeybinds();
            const formatKeys = (keyCodes) => keyCodes.map(code => (document.querySelector(`[data-key="${code}"]`)?.textContent.trim() || code)).join(' + ');

            // --- Element References ---
            const keyboardLayout = document.getElementById('keyboard-layout');
            const keybindDisplay = document.getElementById('keybind-display');
            const searchInput = document.getElementById('search-input');
            const searchContainer = document.getElementById('search-container');
            const searchDropdown = document.getElementById('search-dropdown');
            const searchResultsList = document.getElementById('search-results-list');
            const modal = document.getElementById('createModal');

            // --- State Management ---
            let pressedKeys = new Set();
            let selectedKeys = new Set();
            let activeTimeout = null;
            let recordingKeys = new Set();
            let isRecording = false;
            let nextId = keybindsData.reduce((maxId, item) => item.id.startsWith('custom-') ? Math.max(maxId, parseInt(item.id.split('-')[1], 10) + 1) : maxId, 1);

            // --- Display & UI Functions ---
            const updateDisplay = (filterText = '') => {
                const combinedKeys = new Set([...pressedKeys, ...selectedKeys]);
                keybindDisplay.innerHTML = '';

                const filteredActions = keybindsData.filter(item => {
                    if (combinedKeys.size > 0) return [...combinedKeys].every(key => item.keys.includes(key));
                    return item.action.toLowerCase().includes(filterText.toLowerCase());
                }).sort((a, b) => a.keys.length - b.keys.length);

                if (filteredActions.length > 0) {
                    const ul = document.createElement('ul');
                    filteredActions.forEach(item => {
                        const li = document.createElement('li');
                        li.setAttribute('data-id', item.id);
                        li.innerHTML = `<span>${formatKeys(item.keys)}: ${item.action}</span><span class="remove-button">&times;</span>`;
                        ul.appendChild(li);
                    });
                    keybindDisplay.appendChild(ul);
                } else {
                    keybindDisplay.innerHTML = `<p class="text-gray-400">${combinedKeys.size > 0 || filterText ? 'No commands found.' : 'Select a key or search to begin.'}</p>`;
                }
                
                const createButton = document.createElement('button');
                createButton.id = 'create-keybind-btn';
                createButton.className = 'create-button';
                createButton.textContent = 'Create Your Own Keybind...';
                keybindDisplay.appendChild(createButton);
                createButton.onclick = () => modal.classList.remove('hidden');
            };

            const showSearchDropdown = (filter = '') => {
                searchResultsList.innerHTML = '';
                const uniqueActions = [...new Set(keybindsData.map(item => item.action))];
                const filteredActions = uniqueActions.filter(action => action.toLowerCase().includes(filter.toLowerCase()));

                if (filteredActions.length > 0) {
                    filteredActions.forEach(action => {
                        const li = document.createElement('li');
                        li.textContent = action;
                        li.addEventListener('mousedown', () => {
                            updateDisplay(action);
                            searchInput.value = '';
                            hideSearchDropdown();
                        });
                        searchResultsList.appendChild(li);
                    });
                    searchDropdown.classList.remove('hidden');
                    keybindDisplay.classList.add('display-inactive');
                } else {
                    hideSearchDropdown();
                }
            };
            
            const hideSearchDropdown = () => {
                searchDropdown.classList.add('hidden');
                keybindDisplay.classList.remove('display-inactive');
            };

            // --- Event Listeners ---
            searchInput.addEventListener('focus', () => showSearchDropdown(searchInput.value));
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value;
                showSearchDropdown(searchTerm);
                if (!searchTerm) updateDisplay('');
            });
            
            document.addEventListener('click', (e) => {
                if (!searchContainer.contains(e.target)) hideSearchDropdown();
            });

            document.addEventListener('keydown', (e) => {
                if (document.activeElement === searchInput || isRecording) return;
                const keyElement = document.querySelector(`[data-key="${e.code}"]`);
                if (keyElement) {
                    searchInput.value = '';
                    hideSearchDropdown();
                    if (!e.repeat) keyElement.classList.add('key-pressed');
                    pressedKeys.add(e.code);
                    clearTimeout(activeTimeout);
                    updateDisplay();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (isRecording) return;
                const keyElement = document.querySelector(`[data-key="${e.code}"]`);
                if (keyElement) {
                    keyElement.classList.remove('key-pressed');
                    pressedKeys.delete(e.code);
                    activeTimeout = setTimeout(() => updateDisplay(), 100);
                }
            });

            // REFACTORED: Event delegation for virtual keyboard
            keyboardLayout.addEventListener('click', (e) => {
                const keyElement = e.target.closest('.key');
                if (!keyElement) return;

                searchInput.value = '';
                hideSearchDropdown();
                const keyCode = keyElement.dataset.key;

                if (keyCode === 'ResetDefaults') {
                    keybindsData = [...defaultKeybindsData];
                    saveKeybinds();
                    selectedKeys.clear();
                    pressedKeys.clear();
                    document.querySelectorAll('.key').forEach(k => k.classList.remove('key-selected', 'key-pressed'));
                    updateDisplay();
                    return;
                }
                
                keyElement.classList.toggle('key-selected');
                selectedKeys.has(keyCode) ? selectedKeys.delete(keyCode) : selectedKeys.add(keyCode);
                updateDisplay();
            });

            // --- Modal Logic ---
            const closeModalBtn = document.getElementById('closeModalBtn');
            const saveKeybindBtn = document.getElementById('saveKeybindBtn');
            const recordKeybindBtn = document.getElementById('recordKeybindBtn');
            const clearRecordingBtn = document.getElementById('clearRecordingBtn');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            const keyCombinationDisplay = document.getElementById('keyCombinationDisplay');
            const keyActionInput = document.getElementById('keyAction');

            const checkForConflicts = (keysToCheck) => {
                const sortedKeys = [...keysToCheck].sort();
                return keybindsData.find(bind => 
                    bind.keys.length === sortedKeys.length && 
                    [...bind.keys].sort().every((val, i) => val === sortedKeys[i])
                )?.action || null;
            };

            const handleRecordingKeyDown = (e) => {
                if (e.target === keyActionInput || e.code === 'Escape' || e.code === 'Enter') return e.preventDefault();
                if (!e.repeat) recordingKeys.add(e.code);
                keyCombinationDisplay.textContent = formatKeys([...recordingKeys].sort());
            };
            
            const stopRecording = () => {
                isRecording = false;
                recordKeybindBtn.classList.remove('disabled-button');
                clearRecordingBtn.classList.add('disabled-button');
                stopRecordingBtn.classList.add('disabled-button');
                document.removeEventListener('keydown', handleRecordingKeyDown);
                keyCombinationDisplay.setAttribute('data-keybind-combo', JSON.stringify([...recordingKeys].sort()));

                const conflictAction = checkForConflicts([...recordingKeys]);
                modal.querySelector('.conflict-warning')?.remove();

                if (conflictAction && recordingKeys.size > 0) {
                    keyCombinationDisplay.classList.add('key-combo-conflict');
                    const warningEl = document.createElement('div');
                    warningEl.className = 'conflict-warning';
                    warningEl.textContent = `‚ö†Ô∏è Warning: This is already used for "${conflictAction}".`;
                    keyCombinationDisplay.after(warningEl);
                } else {
                    keyCombinationDisplay.classList.remove('key-combo-conflict');
                }
            };
            
            recordKeybindBtn.onclick = () => {
                isRecording = true;
                recordingKeys.clear();
                keyCombinationDisplay.textContent = 'Recording...';
                recordKeybindBtn.classList.add('disabled-button');
                clearRecordingBtn.classList.remove('disabled-button');
                stopRecordingBtn.classList.remove('disabled-button');
                document.addEventListener('keydown', handleRecordingKeyDown);
                keyCombinationDisplay.classList.remove('key-combo-conflict');
                modal.querySelector('.conflict-warning')?.remove();
            };

            clearRecordingBtn.onclick = () => {
                if(isRecording) {
                    recordingKeys.clear();
                    keyCombinationDisplay.textContent = 'Recording...';
                    keyCombinationDisplay.setAttribute('data-keybind-combo', '[]');
                    keyCombinationDisplay.classList.remove('key-combo-conflict');
                    modal.querySelector('.conflict-warning')?.remove();
                }
            };
            
            stopRecordingBtn.onclick = stopRecording;

            const resetModal = () => {
                modal.classList.add('hidden');
                if(isRecording) stopRecording();
                recordingKeys.clear();
                keyCombinationDisplay.textContent = 'Press the "Record Keybind" button below to start...';
                keyCombinationDisplay.setAttribute('data-keybind-combo', '');
                keyActionInput.value = '';
                keyCombinationDisplay.classList.remove('key-combo-conflict');
                modal.querySelector('.conflict-warning')?.remove();
            };

            closeModalBtn.onclick = resetModal;

            saveKeybindBtn.onclick = () => {
                const comboAttr = keyCombinationDisplay.getAttribute('data-keybind-combo');
                const newKeys = comboAttr ? JSON.parse(comboAttr) : [];
                const newAction = keyActionInput.value.trim();

                if (newKeys.length > 0 && newAction) {
                    keybindsData.push({ id: `custom-${nextId++}`, keys: newKeys, action: newAction });
                    saveKeybinds();
                    updateDisplay();
                    resetModal();
                } else {
                     const message = "Please provide both a key combination and an action description.";
                     const modalDiv = document.createElement('div');
                     modalDiv.className = 'modal';
                     modalDiv.innerHTML = `<div class="modal-content" style="z-index: 101;"><span class="close-button">&times;</span><p>${message}</p></div>`;
                     document.body.appendChild(modalDiv);
                     modalDiv.querySelector('.close-button').onclick = () => modalDiv.remove();
                }
            };
            
            window.onclick = (event) => { if (event.target == modal) resetModal(); };

            keybindDisplay.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-button')) {
                    const idToRemove = e.target.closest('li').getAttribute('data-id');
                    keybindsData = keybindsData.filter(item => item.id !== idToRemove);
                    saveKeybinds();
                    updateDisplay(searchInput.value);
                }
            });

            // --- Initial Load ---
            updateDisplay();
        });
    </script>
</body>
</html>
